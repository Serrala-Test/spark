-- Automatically generated by SQLQueryTestSuite
-- !query
create temporary view t1 as select * from values
  ("t1a", 6S, 8, 10L, float(15.0), 20D, 20E2BD, timestamp '2014-04-04 01:00:00.000', date '2014-04-04'),
  ("t1b", 8S, 16, 19L, float(17.0), 25D, 26E2BD, timestamp '2014-05-04 01:01:00.000', date '2014-05-04'),
  ("t1a", 16S, 12, 21L, float(15.0), 20D, 20E2BD, timestamp '2014-06-04 01:02:00.001', date '2014-06-04'),
  ("t1a", 16S, 12, 10L, float(15.0), 20D, 20E2BD, timestamp '2014-07-04 01:01:00.000', date '2014-07-04'),
  ("t1c", 8S, 16, 19L, float(17.0), 25D, 26E2BD, timestamp '2014-05-04 01:02:00.001', date '2014-05-05'),
  ("t1d", null, 16, 22L, float(17.0), 25D, 26E2BD, timestamp '2014-06-04 01:01:00.000', null),
  ("t1d", null, 16, 19L, float(17.0), 25D, 26E2BD, timestamp '2014-07-04 01:02:00.001', null),
  ("t1e", 10S, null, 25L, float(17.0), 25D, 26E2BD, timestamp '2014-08-04 01:01:00.000', date '2014-08-04'),
  ("t1e", 10S, null, 19L, float(17.0), 25D, 26E2BD, timestamp '2014-09-04 01:02:00.001', date '2014-09-04'),
  ("t1d", 10S, null, 12L, float(17.0), 25D, 26E2BD, timestamp '2015-05-04 01:01:00.000', date '2015-05-04'),
  ("t1a", 6S, 8, 10L, float(15.0), 20D, 20E2BD, timestamp '2014-04-04 01:02:00.001', date '2014-04-04'),
  ("t1e", 10S, null, 19L, float(17.0), 25D, 26E2BD, timestamp '2014-05-04 01:01:00.000', date '2014-05-04')
  as t1(t1a, t1b, t1c, t1d, t1e, t1f, t1g, t1h, t1i)
-- !query schema
struct<>
-- !query output



-- !query
create temporary view t2 as select * from values
  ("t2a", 6S, 12, 14L, float(15), 20D, 20E2BD, timestamp '2014-04-04 01:01:00.000', date '2014-04-04'),
  ("t1b", 10S, 12, 19L, float(17), 25D, 26E2BD, timestamp '2014-05-04 01:01:00.000', date '2014-05-04'),
  ("t1b", 8S, 16, 119L, float(17), 25D, 26E2BD, timestamp '2015-05-04 01:01:00.000', date '2015-05-04'),
  ("t1c", 12S, 16, 219L, float(17), 25D, 26E2BD, timestamp '2016-05-04 01:01:00.000', date '2016-05-04'),
  ("t1b", null, 16, 319L, float(17), 25D, 26E2BD, timestamp '2017-05-04 01:01:00.000', null),
  ("t2e", 8S, null, 419L, float(17), 25D, 26E2BD, timestamp '2014-06-04 01:01:00.000', date '2014-06-04'),
  ("t1f", 19S, null, 519L, float(17), 25D, 26E2BD, timestamp '2014-05-04 01:01:00.000', date '2014-05-04'),
  ("t1b", 10S, 12, 19L, float(17), 25D, 26E2BD, timestamp '2014-06-04 01:01:00.000', date '2014-06-04'),
  ("t1b", 8S, 16, 19L, float(17), 25D, 26E2BD, timestamp '2014-07-04 01:01:00.000', date '2014-07-04'),
  ("t1c", 12S, 16, 19L, float(17), 25D, 26E2BD, timestamp '2014-08-04 01:01:00.000', date '2014-08-05'),
  ("t1e", 8S, null, 19L, float(17), 25D, 26E2BD, timestamp '2014-09-04 01:01:00.000', date '2014-09-04'),
  ("t1f", 19S, null, 19L, float(17), 25D, 26E2BD, timestamp '2014-10-04 01:01:00.000', date '2014-10-04'),
  ("t1b", null, 16, 19L, float(17), 25D, 26E2BD, timestamp '2014-05-04 01:01:00.000', null)
  as t2(t2a, t2b, t2c, t2d, t2e, t2f, t2g, t2h, t2i)
-- !query schema
struct<>
-- !query output



-- !query
create temporary view t3 as select * from values
  ("t3a", 6S, 12, 110L, float(15), 20D, 20E2BD, timestamp '2014-04-04 01:02:00.000', date '2014-04-04'),
  ("t3a", 6S, 12, 10L, float(15), 20D, 20E2BD, timestamp '2014-05-04 01:02:00.000', date '2014-05-04'),
  ("t1b", 10S, 12, 219L, float(17), 25D, 26E2BD, timestamp '2014-05-04 01:02:00.000', date '2014-05-04'),
  ("t1b", 10S, 12, 19L, float(17), 25D, 26E2BD, timestamp '2014-05-04 01:02:00.000', date '2014-05-04'),
  ("t1b", 8S, 16, 319L, float(17), 25D, 26E2BD, timestamp '2014-06-04 01:02:00.000', date '2014-06-04'),
  ("t1b", 8S, 16, 19L, float(17), 25D, 26E2BD, timestamp '2014-07-04 01:02:00.000', date '2014-07-04'),
  ("t3c", 17S, 16, 519L, float(17), 25D, 26E2BD, timestamp '2014-08-04 01:02:00.000', date '2014-08-04'),
  ("t3c", 17S, 16, 19L, float(17), 25D, 26E2BD, timestamp '2014-09-04 01:02:00.000', date '2014-09-05'),
  ("t1b", null, 16, 419L, float(17), 25D, 26E2BD, timestamp '2014-10-04 01:02:00.000', null),
  ("t1b", null, 16, 19L, float(17), 25D, 26E2BD, timestamp '2014-11-04 01:02:00.000', null),
  ("t3b", 8S, null, 719L, float(17), 25D, 26E2BD, timestamp '2014-05-04 01:02:00.000', date '2014-05-04'),
  ("t3b", 8S, null, 19L, float(17), 25D, 26E2BD, timestamp '2015-05-04 01:02:00.000', date '2015-05-04')
  as t3(t3a, t3b, t3c, t3d, t3e, t3f, t3g, t3h, t3i)
-- !query schema
struct<>
-- !query output



-- !query
SELECT t1a,
       Avg(t1b)
FROM   t1
WHERE  t1a IN (SELECT t2a
               FROM   t2)
GROUP  BY t1a
-- !query schema
struct<t1a:string,avg(t1b):double>
-- !query output
t1b	8.0
t1c	8.0
t1e	10.0


-- !query
SELECT t1a,
       Max(t1b)
FROM   t1
WHERE  t1b IN (SELECT t2b
               FROM   t2
               WHERE  t1a = t2a)
GROUP  BY t1a,
          t1d
-- !query schema
struct<t1a:string,max(t1b):smallint>
-- !query output
t1b	8


-- !query
SELECT t1a,
       t1b
FROM   t1
WHERE  t1c IN (SELECT t2c
               FROM   t2
               WHERE  t1a = t2a)
GROUP  BY t1a,
          t1b
-- !query schema
struct<t1a:string,t1b:smallint>
-- !query output
t1b	8
t1c	8


-- !query
SELECT t1a,
       Sum(DISTINCT( t1b ))
FROM   t1
WHERE  t1c IN (SELECT t2c
               FROM   t2
               WHERE  t1a = t2a)
        OR t1c IN (SELECT t3c
                   FROM   t3
                   WHERE  t1a = t3a)
GROUP  BY t1a,
          t1c
-- !query schema
struct<t1a:string,sum(DISTINCT t1b):bigint>
-- !query output
t1b	8
t1c	8


-- !query
SELECT t1a,
       Sum(DISTINCT( t1b ))
FROM   t1
WHERE  t1c IN (SELECT t2c
               FROM   t2
               WHERE  t1a = t2a)
       AND t1c IN (SELECT t3c
                   FROM   t3
                   WHERE  t1a = t3a)
GROUP  BY t1a,
          t1c
-- !query schema
struct<t1a:string,sum(DISTINCT t1b):bigint>
-- !query output
t1b	8


-- !query
SELECT t1a,
       Count(DISTINCT( t1b ))
FROM   t1
WHERE  t1c IN (SELECT t2c
               FROM   t2
               WHERE  t1a = t2a)
GROUP  BY t1a,
          t1c
HAVING t1a = "t1b"
-- !query schema
struct<t1a:string,count(DISTINCT t1b):bigint>
-- !query output
t1b	1


-- !query
SELECT *
FROM   t1
WHERE  t1b IN (SELECT Max(t2b)
               FROM   t2
               GROUP  BY t2a)
-- !query schema
struct<t1a:string,t1b:smallint,t1c:int,t1d:bigint,t1e:float,t1f:double,t1g:decimal(4,0),t1h:timestamp,t1i:date>
-- !query output
t1a	6	8	10	15.0	20.0	2000	2014-04-04 01:00:00	2014-04-04
t1a	6	8	10	15.0	20.0	2000	2014-04-04 01:02:00.001	2014-04-04
t1b	8	16	19	17.0	25.0	2600	2014-05-04 01:01:00	2014-05-04
t1c	8	16	19	17.0	25.0	2600	2014-05-04 01:02:00.001	2014-05-05
t1d	10	NULL	12	17.0	25.0	2600	2015-05-04 01:01:00	2015-05-04
t1e	10	NULL	19	17.0	25.0	2600	2014-05-04 01:01:00	2014-05-04
t1e	10	NULL	19	17.0	25.0	2600	2014-09-04 01:02:00.001	2014-09-04
t1e	10	NULL	25	17.0	25.0	2600	2014-08-04 01:01:00	2014-08-04


-- !query
SELECT *
FROM   (SELECT t2a,
               t2b
        FROM   t2
        WHERE  t2a IN (SELECT t1a
                       FROM   t1
                       WHERE  t1b = t2b)
        GROUP  BY t2a,
                  t2b) t2
-- !query schema
struct<t2a:string,t2b:smallint>
-- !query output
t1b	8


-- !query
SELECT Count(DISTINCT * )
FROM   t1
WHERE  t1b IN (SELECT Min(t2b)
               FROM   t2
               WHERE  t1a = t2a
                      AND t1c = t2c
               GROUP  BY t2a)
-- !query schema
struct<count(DISTINCT t1a, t1b, t1c, t1d, t1e, t1f, t1g, t1h, t1i):bigint>
-- !query output
1


-- !query
SELECT t1a,
       t1b
FROM   t1
WHERE  t1c IN (SELECT Max(t2c)
               FROM   t2
               WHERE  t1a = t2a
               GROUP  BY t2a,
                         t2c
               HAVING t2c > 8)
-- !query schema
struct<t1a:string,t1b:smallint>
-- !query output
t1b	8
t1c	8


-- !query
SELECT t1a,
       t1b
FROM   t1
WHERE  t1c IN (SELECT t2c
               FROM   t2
               WHERE  t2a IN (SELECT Min(t3a)
                              FROM   t3
                              WHERE  t3a = t2a
                              GROUP  BY t3b)
               GROUP  BY t2c)
-- !query schema
struct<t1a:string,t1b:smallint>
-- !query output
t1a	16
t1a	16
t1b	8
t1c	8
t1d	NULL
t1d	NULL


-- !query
SELECT t1a,
       Min(t1b)
FROM   t1
WHERE  t1c IN (SELECT Min(t2c)
               FROM   t2
               WHERE  t2b = t1b
               GROUP  BY t2a)
GROUP  BY t1a
-- !query schema
struct<t1a:string,min(t1b):smallint>
-- !query output
t1b	8
t1c	8


-- !query
SELECT t1a,
       Min(t1b)
FROM   t1
WHERE  t1c IN (SELECT Min(t2c)
               FROM   t2
               WHERE  t2b IN (SELECT Min(t3b)
                              FROM   t3
                              WHERE  t2a = t3a
                              GROUP  BY t3a)
               GROUP  BY t2c)
GROUP  BY t1a,
          t1d
-- !query schema
struct<t1a:string,min(t1b):smallint>
-- !query output
t1b	8
t1c	8
t1d	NULL
t1d	NULL


-- !query
SELECT t1a,
       Min(t1b)
FROM   t1
WHERE  t1c IN (SELECT Min(t2c)
               FROM   t2
               WHERE  t2b = t1b
               GROUP  BY t2a)
       AND t1d IN (SELECT t3d
                   FROM   t3
                   WHERE  t1c = t3c
                   GROUP  BY t3d)
GROUP  BY t1a
-- !query schema
struct<t1a:string,min(t1b):smallint>
-- !query output
t1b	8
t1c	8


-- !query
SELECT t1a,
       Min(t1b)
FROM   t1
WHERE  t1c IN (SELECT Min(t2c)
               FROM   t2
               WHERE  t2b = t1b
               GROUP  BY t2a)
        OR t1d IN (SELECT t3d
                   FROM   t3
                   WHERE  t1c = t3c
                   GROUP  BY t3d)
GROUP  BY t1a
-- !query schema
struct<t1a:string,min(t1b):smallint>
-- !query output
t1a	16
t1b	8
t1c	8
t1d	NULL


-- !query
SELECT t1a,
       Min(t1b)
FROM   t1
WHERE  t1c IN (SELECT Min(t2c)
               FROM   t2
               WHERE  t2b = t1b
               GROUP  BY t2a
               HAVING t2a > t1a)
        OR t1d IN (SELECT t3d
                   FROM   t3
                   WHERE  t1c = t3c
                   GROUP  BY t3d
                   HAVING t3d = t1d)
GROUP  BY t1a
HAVING Min(t1b) IS NOT NULL
-- !query schema
struct<t1a:string,min(t1b):smallint>
-- !query output
t1a	16
t1b	8
t1c	8


-- !query
select t1a
from t1
where t1f IN (SELECT RANK() OVER (partition by t3c  order by t2b) as s
                             FROM t2, t3 where t2.t2c = t3.t3c and t2.t2a < t1.t1a)
-- !query schema
struct<t1a:string>
-- !query output
t1d
t1d
t1d
t1e
t1e
t1e


-- !query
SELECT
  t1.t1a,
  t1.t1a IN (SELECT t2a FROM t2) as v1
FROM t1
GROUP BY t1.t1a
-- !query schema
struct<t1a:string,v1:boolean>
-- !query output
t1a	false
t1b	true
t1c	true
t1d	false
t1e	true


-- !query
SELECT
  t1.t1a,
  t1.t1a IN (SELECT t2a FROM t2 WHERE length(t2a) = length(t1a)) as v1
FROM t1
GROUP BY t1.t1a
-- !query schema
struct<>
-- !query output
org.apache.spark.SparkException
{
  "errorClass" : "PLAN_VALIDATION_FAILED_RULE_IN_BATCH",
  "sqlState" : "XXKD0",
  "messageParameters" : {
    "batch" : "Pullup Correlated Expressions",
    "reason" : "Aggregate: Aggregate [t1a#x], [t1a#x, t1a#x IN (list#x [t1a#x && (length(t2a#x) = length(t1a#x))]) AS v1#x]\n:  +- Project [t2a#x]\n:     +- Project [cast(t2a#x as string) AS t2a#x, cast(t2b#x as smallint) AS t2b#x, cast(t2c#x as int) AS t2c#x, cast(t2d#xL as bigint) AS t2d#xL, cast(t2e#x as float) AS t2e#x, cast(t2f#x as double) AS t2f#x, cast(t2g#x as decimal(4,0)) AS t2g#x, cast(t2h#x as timestamp) AS t2h#x, cast(t2i#x as date) AS t2i#x]\n:        +- Project [t2a#x, t2b#x, t2c#x, t2d#xL, t2e#x, t2f#x, t2g#x, t2h#x, t2i#x]\n:           +- LocalRelation [t2a#x, t2b#x, t2c#x, t2d#xL, t2e#x, t2f#x, t2g#x, t2h#x, t2i#x]\n+- Project [cast(t1a#x as string) AS t1a#x, cast(t1b#x as smallint) AS t1b#x, cast(t1c#x as int) AS t1c#x, cast(t1d#xL as bigint) AS t1d#xL, cast(t1e#x as float) AS t1e#x, cast(t1f#x as double) AS t1f#x, cast(t1g#x as decimal(4,0)) AS t1g#x, cast(t1h#x as timestamp) AS t1h#x, cast(t1i#x as date) AS t1i#x]\n   +- LocalRelation [t1a#x, t1b#x, t1c#x, t1d#xL, t1e#x, t1f#x, t1g#x, t1h#x, t1i#x]\n is not a valid aggregate expression: [MISSING_AGGREGATION] The non-aggregating expression \"t2a\" is based on columns which are not participating in the GROUP BY clause.\nAdd the columns or the expression to the GROUP BY, aggregate the expression, or use \"any_value(t2a)\" if you do not care which of the values within a group is returned. SQLSTATE: 42803\nPrevious schema:t1a#x, v1#x\nPrevious plan: Aggregate [t1a#x], [t1a#x, t1a#x IN (list#x [t1a#x]) AS v1#x]\n:  +- Project [t2a#x]\n:     +- Filter (length(t2a#x) = length(outer(t1a#x)))\n:        +- Project [cast(t2a#x as string) AS t2a#x, cast(t2b#x as smallint) AS t2b#x, cast(t2c#x as int) AS t2c#x, cast(t2d#xL as bigint) AS t2d#xL, cast(t2e#x as float) AS t2e#x, cast(t2f#x as double) AS t2f#x, cast(t2g#x as decimal(4,0)) AS t2g#x, cast(t2h#x as timestamp) AS t2h#x, cast(t2i#x as date) AS t2i#x]\n:           +- Project [t2a#x, t2b#x, t2c#x, t2d#xL, t2e#x, t2f#x, t2g#x, t2h#x, t2i#x]\n:              +- LocalRelation [t2a#x, t2b#x, t2c#x, t2d#xL, t2e#x, t2f#x, t2g#x, t2h#x, t2i#x]\n+- Project [cast(t1a#x as string) AS t1a#x, cast(t1b#x as smallint) AS t1b#x, cast(t1c#x as int) AS t1c#x, cast(t1d#xL as bigint) AS t1d#xL, cast(t1e#x as float) AS t1e#x, cast(t1f#x as double) AS t1f#x, cast(t1g#x as decimal(4,0)) AS t1g#x, cast(t1h#x as timestamp) AS t1h#x, cast(t1i#x as date) AS t1i#x]\n   +- LocalRelation [t1a#x, t1b#x, t1c#x, t1d#xL, t1e#x, t1f#x, t1g#x, t1h#x, t1i#x]\n",
    "rule" : "org.apache.spark.sql.catalyst.optimizer.PullupCorrelatedPredicates"
  }
}


-- !query
SELECT
  count(cast(t1.t1a IN (SELECT t2a FROM t2) as INT)),
  sum(cast(t1.t1b IN (SELECT t2b FROM t2) as INT))
FROM t1
-- !query schema
struct<count(CAST((t1a IN (listquery())) AS INT)):bigint,sum(CAST((t1b IN (listquery())) AS INT)):bigint>
-- !query output
12	8


-- !query
SELECT
   t1.t1a,
   t1.t1a IN
       (SELECT t2a FROM t2 WHERE t2a IN (SELECT t3a FROM t3 WHERE t3b > 0)) as v1
FROM t1
GROUP BY t1.t1a
-- !query schema
struct<>
-- !query output
org.apache.spark.SparkRuntimeException
{
  "errorClass" : "_LEGACY_ERROR_TEMP_2169"
}


-- !query
SELECT
    agg_results.t1a,
    COUNT(*)
    FROM (SELECT t1.t1a FROM t1 WHERE t1.t1a IN (SELECT t2a FROM t2)) AS agg_results
GROUP BY agg_results.t1a
-- !query schema
struct<t1a:string,count(1):bigint>
-- !query output
t1b	1
t1c	1
t1e	3


-- !query
SELECT
  t1.t1a,
  CASE
    WHEN t1.t1a IN (SELECT t2a FROM t2) THEN 10
    ELSE -10
  END AS v1
FROM t1
GROUP BY t1.t1a
-- !query schema
struct<t1a:string,v1:int>
-- !query output
t1a	-10
t1b	10
t1c	10
t1d	-10
t1e	10


-- !query
SELECT
  t1.t1c,
  SUM(CASE
    WHEN t1.t1c IN (SELECT t2c FROM t2) THEN 10
    ELSE -10
  END) AS v1,
  SUM(CASE
      WHEN t1.t1d IN (SELECT t2c FROM t2) THEN 10
      ELSE -10
    END) AS v2,
  t1.t1c + 10 IN (SELECT t2c + 2 FROM t2) AS v3,
  count(t1.t1c) as ct,
  count(t1.t1d)
FROM t1
GROUP BY t1.t1c
-- !query schema
struct<t1c:int,v1:bigint,v2:bigint,v3:boolean,ct:bigint,count(t1d):bigint>
-- !query output
12	20	-20	false	2	2
16	40	-40	false	4	4
8	-20	-20	true	2	2
NULL	-40	-20	false	0	4


-- !query
SELECT
  SUM(CASE
    WHEN t1.t1c IN (SELECT t2c FROM t2) THEN 10
    ELSE -10
  END) AS v1,
  count(t1.t1c) as ct
FROM t1
-- !query schema
struct<v1:bigint,ct:bigint>
-- !query output
0	8
