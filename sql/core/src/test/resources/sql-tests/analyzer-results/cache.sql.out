-- Automatically generated by SQLQueryTestSuite
-- !query
CREATE TEMPORARY VIEW t1 AS SELECT * FROM VALUES (0, 0), (1, 1), (2, 2) AS t(c1, c2)
-- !query analysis
CreateViewCommand `t1`, SELECT * FROM VALUES (0, 0), (1, 1), (2, 2) AS t(c1, c2), false, false, LocalTempView, UNSUPPORTED, true
   +- Project [c1#x, c2#x]
      +- SubqueryAlias t
         +- LocalRelation [c1#x, c2#x]


-- !query
CREATE TEMPORARY VIEW t2 AS
WITH v as (
  SELECT c1 + c1 c3 FROM t1
)
SELECT SUM(c3) s FROM v
-- !query analysis
CreateViewCommand `t2`, WITH v as (
  SELECT c1 + c1 c3 FROM t1
)
SELECT SUM(c3) s FROM v, false, false, LocalTempView, UNSUPPORTED, true
   +- WithCTE
      :- CTERelationDef xxxx, false
      :  +- SubqueryAlias v
      :     +- Project [(c1#x + c1#x) AS c3#x]
      :        +- SubqueryAlias t1
      :           +- View (`t1`, [c1#x, c2#x])
      :              +- Project [cast(c1#x as int) AS c1#x, cast(c2#x as int) AS c2#x]
      :                 +- Project [c1#x, c2#x]
      :                    +- SubqueryAlias t
      :                       +- LocalRelation [c1#x, c2#x]
      +- Aggregate [sum(c3#x) AS s#xL]
         +- SubqueryAlias v
            +- CTERelationRef xxxx, true, [c3#x], false


-- !query
CACHE TABLE cache_table
WITH
t2 AS (SELECT 1)
SELECT * FROM t2
-- !query analysis
CacheTableAsSelect cache_table, WITH
t2 AS (SELECT 1)
SELECT * FROM t2, false, true
   +- WithCTE
      :- CTERelationDef xxxx, false
      :  +- SubqueryAlias t2
      :     +- Project [1 AS 1#x]
      :        +- OneRowRelation
      +- Project [1#x]
         +- SubqueryAlias t2
            +- CTERelationRef xxxx, true, [1#x], false


-- !query
SELECT * FROM cache_table
-- !query analysis
Project [1#x]
+- SubqueryAlias cache_table
   +- View (`cache_table`, [1#x])
      +- Project [cast(1#x as int) AS 1#x]
         +- WithCTE
            :- CTERelationDef xxxx, false
            :  +- SubqueryAlias t2
            :     +- Project [1 AS 1#x]
            :        +- OneRowRelation
            +- Project [1#x]
               +- SubqueryAlias t2
                  +- CTERelationRef xxxx, true, [1#x], false


-- !query
EXPLAIN EXTENDED SELECT * FROM cache_table
-- !query analysis
ExplainCommand 'Project [*], ExtendedMode


-- !query
CACHE TABLE cache_nested_cte_table
WITH
v AS (
  SELECT c1 * c2 c3 from t1
)
SELECT SUM(c3) FROM v
EXCEPT
SELECT s FROM t2
-- !query analysis
CacheTableAsSelect cache_nested_cte_table, WITH
v AS (
  SELECT c1 * c2 c3 from t1
)
SELECT SUM(c3) FROM v
EXCEPT
SELECT s FROM t2, false, true
   +- WithCTE
      :- CTERelationDef xxxx, false
      :  +- SubqueryAlias v
      :     +- Project [(c1#x * c2#x) AS c3#x]
      :        +- SubqueryAlias t1
      :           +- View (`t1`, [c1#x, c2#x])
      :              +- Project [cast(c1#x as int) AS c1#x, cast(c2#x as int) AS c2#x]
      :                 +- Project [c1#x, c2#x]
      :                    +- SubqueryAlias t
      :                       +- LocalRelation [c1#x, c2#x]
      +- Except false
         :- Aggregate [sum(c3#x) AS sum(c3)#xL]
         :  +- SubqueryAlias v
         :     +- CTERelationRef xxxx, true, [c3#x], false
         +- Project [s#xL]
            +- SubqueryAlias t2
               +- View (`t2`, [s#xL])
                  +- Project [cast(s#xL as bigint) AS s#xL]
                     +- WithCTE
                        :- CTERelationDef xxxx, false
                        :  +- SubqueryAlias v
                        :     +- Project [(c1#x + c1#x) AS c3#x]
                        :        +- SubqueryAlias t1
                        :           +- View (`t1`, [c1#x, c2#x])
                        :              +- Project [cast(c1#x as int) AS c1#x, cast(c2#x as int) AS c2#x]
                        :                 +- Project [c1#x, c2#x]
                        :                    +- SubqueryAlias t
                        :                       +- LocalRelation [c1#x, c2#x]
                        +- Aggregate [sum(c3#x) AS s#xL]
                           +- SubqueryAlias v
                              +- CTERelationRef xxxx, true, [c3#x], false


-- !query
SELECT * FROM cache_nested_cte_table
-- !query analysis
Project [sum(c3)#xL]
+- SubqueryAlias cache_nested_cte_table
   +- View (`cache_nested_cte_table`, [sum(c3)#xL])
      +- Project [cast(sum(c3)#xL as bigint) AS sum(c3)#xL]
         +- WithCTE
            :- CTERelationDef xxxx, false
            :  +- SubqueryAlias v
            :     +- Project [(c1#x * c2#x) AS c3#x]
            :        +- SubqueryAlias t1
            :           +- View (`t1`, [c1#x, c2#x])
            :              +- Project [cast(c1#x as int) AS c1#x, cast(c2#x as int) AS c2#x]
            :                 +- Project [c1#x, c2#x]
            :                    +- SubqueryAlias t
            :                       +- LocalRelation [c1#x, c2#x]
            +- Except false
               :- Aggregate [sum(c3#x) AS sum(c3)#xL]
               :  +- SubqueryAlias v
               :     +- CTERelationRef xxxx, true, [c3#x], false
               +- Project [s#xL]
                  +- SubqueryAlias t2
                     +- View (`t2`, [s#xL])
                        +- Project [cast(s#xL as bigint) AS s#xL]
                           +- WithCTE
                              :- CTERelationDef xxxx, false
                              :  +- SubqueryAlias v
                              :     +- Project [(c1#x + c1#x) AS c3#x]
                              :        +- SubqueryAlias t1
                              :           +- View (`t1`, [c1#x, c2#x])
                              :              +- Project [cast(c1#x as int) AS c1#x, cast(c2#x as int) AS c2#x]
                              :                 +- Project [c1#x, c2#x]
                              :                    +- SubqueryAlias t
                              :                       +- LocalRelation [c1#x, c2#x]
                              +- Aggregate [sum(c3#x) AS s#xL]
                                 +- SubqueryAlias v
                                    +- CTERelationRef xxxx, true, [c3#x], false


-- !query
EXPLAIN EXTENDED SELECT * FROM cache_nested_cte_table
-- !query analysis
ExplainCommand 'Project [*], ExtendedMode


-- !query
DROP TABLE IF EXISTS t1
-- !query analysis
DropTempViewCommand t1


-- !query
DROP TABLE IF EXISTS t2
-- !query analysis
DropTempViewCommand t2
