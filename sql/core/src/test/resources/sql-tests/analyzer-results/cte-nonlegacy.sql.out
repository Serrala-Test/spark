-- Automatically generated by SQLQueryTestSuite
-- !query
WITH t as (
  WITH t2 AS (SELECT 1)
  SELECT * FROM t2
)
SELECT * FROM t
-- !query analysis
WithCTE
:- CTERelationDef 226, false
:  +- SubqueryAlias t2
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 227, false
:  +- SubqueryAlias t
:     +- Project [1#x]
:        +- SubqueryAlias t2
:           +- CTERelationRef 226, true, [1#x]
+- Project [1#x]
   +- SubqueryAlias t
      +- CTERelationRef 227, true, [1#x]


-- !query
SELECT max(c) FROM (
  WITH t(c) AS (SELECT 1)
  SELECT * FROM t
)
-- !query analysis
Aggregate [max(c#x) AS max(c)#x]
+- SubqueryAlias __auto_generated_subquery_name
   +- WithCTE
      :- CTERelationDef 228, false
      :  +- SubqueryAlias t
      :     +- Project [1#x AS c#x]
      :        +- Project [1 AS 1#x]
      :           +- OneRowRelation
      +- Project [c#x]
         +- SubqueryAlias t
            +- CTERelationRef 228, true, [c#x]


-- !query
SELECT (
  WITH t AS (SELECT 1)
  SELECT * FROM t
)
-- !query analysis
Project [scalar-subquery#x [] AS scalarsubquery()#x]
:  +- WithCTE
:     :- CTERelationDef 229, false
:     :  +- SubqueryAlias t
:     :     +- Project [1 AS 1#x]
:     :        +- OneRowRelation
:     +- Project [1#x]
:        +- SubqueryAlias t
:           +- CTERelationRef 229, true, [1#x]
+- OneRowRelation


-- !query
SELECT * FROM
  (
   WITH cte AS (SELECT * FROM range(10))
   SELECT * FROM cte WHERE id = 8
  ) a
UNION
SELECT * FROM cte
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`cte`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 120,
    "stopIndex" : 122,
    "fragment" : "cte"
  } ]
}


-- !query
WITH
  t AS (SELECT 1),
  t2 AS (
    WITH t AS (SELECT 2)
    SELECT * FROM t
  )
SELECT * FROM t2
-- !query analysis
WithCTE
:- CTERelationDef 231, false
:  +- SubqueryAlias t
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 232, false
:  +- SubqueryAlias t
:     +- Project [2 AS 2#x]
:        +- OneRowRelation
:- CTERelationDef 233, false
:  +- SubqueryAlias t2
:     +- Project [2#x]
:        +- SubqueryAlias t
:           +- CTERelationRef 232, true, [2#x]
+- Project [2#x]
   +- SubqueryAlias t2
      +- CTERelationRef 233, true, [2#x]


-- !query
WITH
  t(c) AS (SELECT 1),
  t2 AS (
    SELECT (
      SELECT max(c) FROM (
        WITH t(c) AS (SELECT 2)
        SELECT * FROM t
      )
    )
  )
SELECT * FROM t2
-- !query analysis
WithCTE
:- CTERelationDef 234, false
:  +- SubqueryAlias t
:     +- Project [1#x AS c#x]
:        +- Project [1 AS 1#x]
:           +- OneRowRelation
:- CTERelationDef 236, false
:  +- SubqueryAlias t2
:     +- Project [scalar-subquery#x [] AS scalarsubquery()#x]
:        :  +- Aggregate [max(c#x) AS max(c)#x]
:        :     +- SubqueryAlias __auto_generated_subquery_name
:        :        +- WithCTE
:        :           :- CTERelationDef 235, false
:        :           :  +- SubqueryAlias t
:        :           :     +- Project [2#x AS c#x]
:        :           :        +- Project [2 AS 2#x]
:        :           :           +- OneRowRelation
:        :           +- Project [c#x]
:        :              +- SubqueryAlias t
:        :                 +- CTERelationRef 235, true, [c#x]
:        +- OneRowRelation
+- Project [scalarsubquery()#x]
   +- SubqueryAlias t2
      +- CTERelationRef 236, true, [scalarsubquery()#x]


-- !query
WITH
  t AS (SELECT 1),
  t2 AS (
    WITH t AS (SELECT 2),
    t2 AS (
      WITH t AS (SELECT 3)
      SELECT * FROM t
    )
    SELECT * FROM t2
  )
SELECT * FROM t2
-- !query analysis
WithCTE
:- CTERelationDef 237, false
:  +- SubqueryAlias t
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 238, false
:  +- SubqueryAlias t
:     +- Project [2 AS 2#x]
:        +- OneRowRelation
:- CTERelationDef 239, false
:  +- SubqueryAlias t
:     +- Project [3 AS 3#x]
:        +- OneRowRelation
:- CTERelationDef 240, false
:  +- SubqueryAlias t2
:     +- Project [3#x]
:        +- SubqueryAlias t
:           +- CTERelationRef 239, true, [3#x]
:- CTERelationDef 241, false
:  +- SubqueryAlias t2
:     +- Project [3#x]
:        +- SubqueryAlias t2
:           +- CTERelationRef 240, true, [3#x]
+- Project [3#x]
   +- SubqueryAlias t2
      +- CTERelationRef 241, true, [3#x]


-- !query
WITH t(c) AS (SELECT 1)
SELECT max(c) FROM (
  WITH t(c) AS (SELECT 2)
  SELECT * FROM t
)
-- !query analysis
WithCTE
:- CTERelationDef 242, false
:  +- SubqueryAlias t
:     +- Project [1#x AS c#x]
:        +- Project [1 AS 1#x]
:           +- OneRowRelation
:- CTERelationDef 243, false
:  +- SubqueryAlias t
:     +- Project [2#x AS c#x]
:        +- Project [2 AS 2#x]
:           +- OneRowRelation
+- Aggregate [max(c#x) AS max(c)#x]
   +- SubqueryAlias __auto_generated_subquery_name
      +- Project [c#x]
         +- SubqueryAlias t
            +- CTERelationRef 243, true, [c#x]


-- !query
WITH t(c) AS (SELECT 1)
SELECT sum(c) FROM (
  SELECT max(c) AS c FROM (
    WITH t(c) AS (SELECT 2)
    SELECT * FROM t
  )
)
-- !query analysis
WithCTE
:- CTERelationDef 244, false
:  +- SubqueryAlias t
:     +- Project [1#x AS c#x]
:        +- Project [1 AS 1#x]
:           +- OneRowRelation
:- CTERelationDef 245, false
:  +- SubqueryAlias t
:     +- Project [2#x AS c#x]
:        +- Project [2 AS 2#x]
:           +- OneRowRelation
+- Aggregate [sum(c#x) AS sum(c)#xL]
   +- SubqueryAlias __auto_generated_subquery_name
      +- Aggregate [max(c#x) AS c#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [c#x]
               +- SubqueryAlias t
                  +- CTERelationRef 245, true, [c#x]


-- !query
WITH t(c) AS (SELECT 1)
SELECT sum(c) FROM (
  WITH t(c) AS (SELECT 2)
  SELECT max(c) AS c FROM (
    WITH t(c) AS (SELECT 3)
    SELECT * FROM t
  )
)
-- !query analysis
WithCTE
:- CTERelationDef 246, false
:  +- SubqueryAlias t
:     +- Project [1#x AS c#x]
:        +- Project [1 AS 1#x]
:           +- OneRowRelation
:- CTERelationDef 247, false
:  +- SubqueryAlias t
:     +- Project [2#x AS c#x]
:        +- Project [2 AS 2#x]
:           +- OneRowRelation
:- CTERelationDef 248, false
:  +- SubqueryAlias t
:     +- Project [3#x AS c#x]
:        +- Project [3 AS 3#x]
:           +- OneRowRelation
+- Aggregate [sum(c#x) AS sum(c)#xL]
   +- SubqueryAlias __auto_generated_subquery_name
      +- Aggregate [max(c#x) AS c#x]
         +- SubqueryAlias __auto_generated_subquery_name
            +- Project [c#x]
               +- SubqueryAlias t
                  +- CTERelationRef 248, true, [c#x]


-- !query
WITH t AS (SELECT 1)
SELECT (
  WITH t AS (SELECT 2)
  SELECT * FROM t
)
-- !query analysis
WithCTE
:- CTERelationDef 249, false
:  +- SubqueryAlias t
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
+- Project [scalar-subquery#x [] AS scalarsubquery()#x]
   :  +- WithCTE
   :     :- CTERelationDef 250, false
   :     :  +- SubqueryAlias t
   :     :     +- Project [2 AS 2#x]
   :     :        +- OneRowRelation
   :     +- Project [2#x]
   :        +- SubqueryAlias t
   :           +- CTERelationRef 250, true, [2#x]
   +- OneRowRelation


-- !query
WITH t AS (SELECT 1)
SELECT (
  SELECT (
    WITH t AS (SELECT 2)
    SELECT * FROM t
  )
)
-- !query analysis
WithCTE
:- CTERelationDef 251, false
:  +- SubqueryAlias t
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
+- Project [scalar-subquery#x [] AS scalarsubquery()#x]
   :  +- Project [scalar-subquery#x [] AS scalarsubquery()#x]
   :     :  +- WithCTE
   :     :     :- CTERelationDef 252, false
   :     :     :  +- SubqueryAlias t
   :     :     :     +- Project [2 AS 2#x]
   :     :     :        +- OneRowRelation
   :     :     +- Project [2#x]
   :     :        +- SubqueryAlias t
   :     :           +- CTERelationRef 252, true, [2#x]
   :     +- OneRowRelation
   +- OneRowRelation


-- !query
WITH t AS (SELECT 1)
SELECT (
  WITH t AS (SELECT 2)
  SELECT (
    WITH t AS (SELECT 3)
    SELECT * FROM t
  )
)
-- !query analysis
WithCTE
:- CTERelationDef 253, false
:  +- SubqueryAlias t
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
+- Project [scalar-subquery#x [] AS scalarsubquery()#x]
   :  +- WithCTE
   :     :- CTERelationDef 254, false
   :     :  +- SubqueryAlias t
   :     :     +- Project [2 AS 2#x]
   :     :        +- OneRowRelation
   :     +- Project [scalar-subquery#x [] AS scalarsubquery()#x]
   :        :  +- WithCTE
   :        :     :- CTERelationDef 255, false
   :        :     :  +- SubqueryAlias t
   :        :     :     +- Project [3 AS 3#x]
   :        :     :        +- OneRowRelation
   :        :     +- Project [3#x]
   :        :        +- SubqueryAlias t
   :        :           +- CTERelationRef 255, true, [3#x]
   :        +- OneRowRelation
   +- OneRowRelation


-- !query
WITH t(c) AS (SELECT 1)
SELECT * FROM t
WHERE c IN (
  WITH t(c) AS (SELECT 2)
  SELECT * FROM t
)
-- !query analysis
WithCTE
:- CTERelationDef 256, false
:  +- SubqueryAlias t
:     +- Project [1#x AS c#x]
:        +- Project [1 AS 1#x]
:           +- OneRowRelation
+- Project [c#x]
   +- Filter c#x IN (list#x [])
      :  +- WithCTE
      :     :- CTERelationDef 257, false
      :     :  +- SubqueryAlias t
      :     :     +- Project [2#x AS c#x]
      :     :        +- Project [2 AS 2#x]
      :     :           +- OneRowRelation
      :     +- Project [c#x]
      :        +- SubqueryAlias t
      :           +- CTERelationRef 257, true, [c#x]
      +- SubqueryAlias t
         +- CTERelationRef 256, true, [c#x]


-- !query
WITH
  t AS (
    WITH t2 AS (SELECT 1)
    SELECT * FROM t2
  ),
  t2 AS (SELECT 2)
SELECT * FROM t
-- !query analysis
WithCTE
:- CTERelationDef 258, false
:  +- SubqueryAlias t2
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 259, false
:  +- SubqueryAlias t
:     +- Project [1#x]
:        +- SubqueryAlias t2
:           +- CTERelationRef 258, true, [1#x]
:- CTERelationDef 260, false
:  +- SubqueryAlias t2
:     +- Project [2 AS 2#x]
:        +- OneRowRelation
+- Project [1#x]
   +- SubqueryAlias t
      +- CTERelationRef 259, true, [1#x]


-- !query
WITH
  abc AS (SELECT 1),
  t AS (
    WITH aBc AS (SELECT 2)
    SELECT * FROM aBC
  )
SELECT * FROM t
-- !query analysis
WithCTE
:- CTERelationDef 261, false
:  +- SubqueryAlias abc
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 262, false
:  +- SubqueryAlias aBc
:     +- Project [2 AS 2#x]
:        +- OneRowRelation
:- CTERelationDef 263, false
:  +- SubqueryAlias t
:     +- Project [2#x]
:        +- SubqueryAlias aBC
:           +- CTERelationRef 262, true, [2#x]
+- Project [2#x]
   +- SubqueryAlias t
      +- CTERelationRef 263, true, [2#x]


-- !query
WITH abc AS (SELECT 1)
SELECT (
  WITH aBc AS (SELECT 2)
  SELECT * FROM aBC
)
-- !query analysis
WithCTE
:- CTERelationDef 264, false
:  +- SubqueryAlias abc
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
+- Project [scalar-subquery#x [] AS scalarsubquery()#x]
   :  +- WithCTE
   :     :- CTERelationDef 265, false
   :     :  +- SubqueryAlias aBc
   :     :     +- Project [2 AS 2#x]
   :     :        +- OneRowRelation
   :     +- Project [2#x]
   :        +- SubqueryAlias aBC
   :           +- CTERelationRef 265, true, [2#x]
   +- OneRowRelation


-- !query
WITH
  t1 AS (SELECT 1),
  t2 AS (
    WITH t3 AS (
      SELECT * FROM t1
    )
    SELECT * FROM t3
  )
SELECT * FROM t2
-- !query analysis
WithCTE
:- CTERelationDef 266, false
:  +- SubqueryAlias t1
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 267, false
:  +- SubqueryAlias t3
:     +- Project [1#x]
:        +- SubqueryAlias t1
:           +- CTERelationRef 266, true, [1#x]
:- CTERelationDef 268, false
:  +- SubqueryAlias t2
:     +- Project [1#x]
:        +- SubqueryAlias t3
:           +- CTERelationRef 267, true, [1#x]
+- Project [1#x]
   +- SubqueryAlias t2
      +- CTERelationRef 268, true, [1#x]


-- !query
WITH cte_outer AS (
  SELECT 1
)
SELECT * FROM (
  WITH cte_inner AS (
    SELECT * FROM cte_outer
  )
  SELECT * FROM cte_inner
)
-- !query analysis
WithCTE
:- CTERelationDef 269, false
:  +- SubqueryAlias cte_outer
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 270, false
:  +- SubqueryAlias cte_inner
:     +- Project [1#x]
:        +- SubqueryAlias cte_outer
:           +- CTERelationRef 269, true, [1#x]
+- Project [1#x]
   +- SubqueryAlias __auto_generated_subquery_name
      +- Project [1#x]
         +- SubqueryAlias cte_inner
            +- CTERelationRef 270, true, [1#x]


-- !query
WITH cte_outer AS (
  SELECT 1
)
SELECT * FROM (
  WITH cte_inner AS (
    SELECT * FROM (
      WITH cte_inner_inner AS (
        SELECT * FROM cte_outer
      )
      SELECT * FROM cte_inner_inner
    )
  )
  SELECT * FROM cte_inner
)
-- !query analysis
WithCTE
:- CTERelationDef 271, false
:  +- SubqueryAlias cte_outer
:     +- Project [1 AS 1#x]
:        +- OneRowRelation
:- CTERelationDef 272, false
:  +- SubqueryAlias cte_inner_inner
:     +- Project [1#x]
:        +- SubqueryAlias cte_outer
:           +- CTERelationRef 271, true, [1#x]
:- CTERelationDef 273, false
:  +- SubqueryAlias cte_inner
:     +- Project [1#x]
:        +- SubqueryAlias __auto_generated_subquery_name
:           +- Project [1#x]
:              +- SubqueryAlias cte_inner_inner
:                 +- CTERelationRef 272, true, [1#x]
+- Project [1#x]
   +- SubqueryAlias __auto_generated_subquery_name
      +- Project [1#x]
         +- SubqueryAlias cte_inner
            +- CTERelationRef 273, true, [1#x]


-- !query
WITH cte_outer AS (
  WITH cte_invisible_inner AS (
    SELECT 1
  )
  SELECT * FROM cte_invisible_inner
)
SELECT * FROM (
  WITH cte_inner AS (
    SELECT * FROM cte_invisible_inner
  )
  SELECT * FROM cte_inner
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`cte_invisible_inner`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 164,
    "stopIndex" : 182,
    "fragment" : "cte_invisible_inner"
  } ]
}


-- !query
WITH cte_outer AS (
  SELECT * FROM (
    WITH cte_invisible_inner AS (
      SELECT 1
    )
    SELECT * FROM cte_invisible_inner
  )
)
SELECT * FROM (
  WITH cte_inner AS (
    SELECT * FROM cte_invisible_inner
  )
  SELECT * FROM cte_inner
)
-- !query analysis
org.apache.spark.sql.AnalysisException
{
  "errorClass" : "TABLE_OR_VIEW_NOT_FOUND",
  "sqlState" : "42P01",
  "messageParameters" : {
    "relationName" : "`cte_invisible_inner`"
  },
  "queryContext" : [ {
    "objectType" : "",
    "objectName" : "",
    "startIndex" : 194,
    "stopIndex" : 212,
    "fragment" : "cte_invisible_inner"
  } ]
}
