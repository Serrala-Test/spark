-- Automatically generated by TPCDSQueryTestSuite

-- !query
WITH cross_items AS
(SELECT i_item_sk ss_item_sk
  FROM item,
    (SELECT
      iss.i_brand_id brand_id,
      iss.i_class_id class_id,
      iss.i_category_id category_id
    FROM store_sales, item iss, date_dim d1
    WHERE ss_item_sk = iss.i_item_sk
      AND ss_sold_date_sk = d1.d_date_sk
      AND d1.d_year BETWEEN 1999 AND 1999 + 2
    INTERSECT
    SELECT
      ics.i_brand_id,
      ics.i_class_id,
      ics.i_category_id
    FROM catalog_sales, item ics, date_dim d2
    WHERE cs_item_sk = ics.i_item_sk
      AND cs_sold_date_sk = d2.d_date_sk
      AND d2.d_year BETWEEN 1999 AND 1999 + 2
    INTERSECT
    SELECT
      iws.i_brand_id,
      iws.i_class_id,
      iws.i_category_id
    FROM web_sales, item iws, date_dim d3
    WHERE ws_item_sk = iws.i_item_sk
      AND ws_sold_date_sk = d3.d_date_sk
      AND d3.d_year BETWEEN 1999 AND 1999 + 2) x
  WHERE i_brand_id = brand_id
    AND i_class_id = class_id
    AND i_category_id = category_id
),
    avg_sales AS
  (SELECT avg(quantity * list_price) average_sales
  FROM (
         SELECT
           ss_quantity quantity,
           ss_list_price list_price
         FROM store_sales, date_dim
         WHERE ss_sold_date_sk = d_date_sk
           AND d_year BETWEEN 1999 AND 2001
         UNION ALL
         SELECT
           cs_quantity quantity,
           cs_list_price list_price
         FROM catalog_sales, date_dim
         WHERE cs_sold_date_sk = d_date_sk
           AND d_year BETWEEN 1999 AND 1999 + 2
         UNION ALL
         SELECT
           ws_quantity quantity,
           ws_list_price list_price
         FROM web_sales, date_dim
         WHERE ws_sold_date_sk = d_date_sk
           AND d_year BETWEEN 1999 AND 1999 + 2) x)
SELECT
  channel,
  i_brand_id,
  i_class_id,
  i_category_id,
  sum(sales),
  sum(number_sales)
FROM (
       SELECT
         'store' channel,
         i_brand_id,
         i_class_id,
         i_category_id,
         sum(ss_quantity * ss_list_price) sales,
         count(*) number_sales
       FROM store_sales, item, date_dim
       WHERE ss_item_sk IN (SELECT ss_item_sk
       FROM cross_items)
         AND ss_item_sk = i_item_sk
         AND ss_sold_date_sk = d_date_sk
         AND d_year = 1999 + 2
         AND d_moy = 11
       GROUP BY i_brand_id, i_class_id, i_category_id
       HAVING sum(ss_quantity * ss_list_price) > (SELECT average_sales
       FROM avg_sales)
       UNION ALL
       SELECT
         'catalog' channel,
         i_brand_id,
         i_class_id,
         i_category_id,
         sum(cs_quantity * cs_list_price) sales,
         count(*) number_sales
       FROM catalog_sales, item, date_dim
       WHERE cs_item_sk IN (SELECT ss_item_sk
       FROM cross_items)
         AND cs_item_sk = i_item_sk
         AND cs_sold_date_sk = d_date_sk
         AND d_year = 1999 + 2
         AND d_moy = 11
       GROUP BY i_brand_id, i_class_id, i_category_id
       HAVING sum(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales)
       UNION ALL
       SELECT
         'web' channel,
         i_brand_id,
         i_class_id,
         i_category_id,
         sum(ws_quantity * ws_list_price) sales,
         count(*) number_sales
       FROM web_sales, item, date_dim
       WHERE ws_item_sk IN (SELECT ss_item_sk
       FROM cross_items)
         AND ws_item_sk = i_item_sk
         AND ws_sold_date_sk = d_date_sk
         AND d_year = 1999 + 2
         AND d_moy = 11
       GROUP BY i_brand_id, i_class_id, i_category_id
       HAVING sum(ws_quantity * ws_list_price) > (SELECT average_sales
       FROM avg_sales)
     ) y
GROUP BY ROLLUP (channel, i_brand_id, i_class_id, i_category_id)
ORDER BY channel, i_brand_id, i_class_id, i_category_id
LIMIT 100
-- !query schema
struct<channel:string,i_brand_id:int,i_class_id:int,i_category_id:int,sum(sales):decimal(38,2),sum(number_sales):bigint>
-- !query output
NULL	NULL	NULL	NULL	674173362.51	155629
catalog	1001001	1	1	115019.61	20
catalog	1001001	1	10	100105.28	23
catalog	1001001	1	2	146344.47	27
catalog	1001001	1	3	22597.19	3
catalog	1001001	1	4	107555.43	23
catalog	1001001	1	5	122521.31	25
catalog	1001001	1	6	16883.97	3
catalog	1001001	1	7	46329.78	9
catalog	1001001	1	8	77861.85	13
catalog	1001001	1	9	99985.35	21
catalog	1001001	1	NULL	855204.24	167
catalog	1001001	11	9	82810.87	12
catalog	1001001	11	NULL	82810.87	12
catalog	1001001	12	10	38427.52	9
catalog	1001001	12	NULL	38427.52	9
catalog	1001001	15	10	59329.31	13
catalog	1001001	15	9	53508.79	7
catalog	1001001	15	NULL	112838.10	20
catalog	1001001	2	2	43967.97	7
catalog	1001001	2	3	68565.38	14
catalog	1001001	2	5	12633.87	3
catalog	1001001	2	NULL	125167.22	24
catalog	1001001	3	1	11100.79	5
catalog	1001001	3	2	60551.64	14
catalog	1001001	3	4	28455.23	4
catalog	1001001	3	6	36821.61	7
catalog	1001001	3	7	17250.82	6
catalog	1001001	3	8	14426.92	4
catalog	1001001	3	9	30078.07	3
catalog	1001001	3	NULL	198685.08	43
catalog	1001001	4	2	45473.85	13
catalog	1001001	4	3	16558.92	8
catalog	1001001	4	4	47553.20	10
catalog	1001001	4	NULL	109585.97	31
catalog	1001001	5	10	29678.50	5
catalog	1001001	5	9	30112.11	12
catalog	1001001	5	NULL	59790.61	17
catalog	1001001	6	9	10261.82	3
catalog	1001001	6	NULL	10261.82	3
catalog	1001001	7	7	18244.94	3
catalog	1001001	7	NULL	18244.94	3
catalog	1001001	8	10	26895.97	6
catalog	1001001	8	7	28872.49	7
catalog	1001001	8	NULL	55768.46	13
catalog	1001001	9	6	30944.19	5
catalog	1001001	9	NULL	30944.19	5
catalog	1001001	NULL	NULL	1697729.02	347
catalog	1001002	1	1	2673969.89	530
catalog	1001002	1	NULL	2673969.89	530
catalog	1001002	12	1	29108.42	7
catalog	1001002	12	NULL	29108.42	7
catalog	1001002	15	1	31143.45	6
catalog	1001002	15	NULL	31143.45	6
catalog	1001002	16	1	70162.42	8
catalog	1001002	16	NULL	70162.42	8
catalog	1001002	2	1	140831.91	29
catalog	1001002	2	NULL	140831.91	29
catalog	1001002	3	1	320175.87	67
catalog	1001002	3	NULL	320175.87	67
catalog	1001002	4	1	133287.96	21
catalog	1001002	4	NULL	133287.96	21
catalog	1001002	5	1	16606.90	9
catalog	1001002	5	NULL	16606.90	9
catalog	1001002	6	1	15133.01	4
catalog	1001002	6	NULL	15133.01	4
catalog	1001002	7	1	24471.26	10
catalog	1001002	7	NULL	24471.26	10
catalog	1001002	8	1	63773.05	12
catalog	1001002	8	NULL	63773.05	12
catalog	1001002	9	1	9167.19	3
catalog	1001002	9	NULL	9167.19	3
catalog	1001002	NULL	NULL	3527831.33	706
catalog	1002001	1	1	76392.13	14
catalog	1002001	1	10	44071.42	4
catalog	1002001	1	2	118394.33	21
catalog	1002001	1	4	29395.79	5
catalog	1002001	1	5	35541.97	4
catalog	1002001	1	6	26104.36	3
catalog	1002001	1	9	18793.97	4
catalog	1002001	1	NULL	348693.97	55
catalog	1002001	2	1	239511.02	51
catalog	1002001	2	10	88249.19	10
catalog	1002001	2	2	147993.14	26
catalog	1002001	2	3	100086.93	17
catalog	1002001	2	4	53524.42	13
catalog	1002001	2	5	48494.06	10
catalog	1002001	2	6	142857.04	20
catalog	1002001	2	7	116557.98	16
catalog	1002001	2	8	92743.93	24
catalog	1002001	2	9	203943.99	38
catalog	1002001	2	NULL	1233961.70	225
catalog	1002001	3	2	25171.13	6
catalog	1002001	3	7	27766.70	3
catalog	1002001	3	8	38116.49	8
catalog	1002001	3	NULL	91054.32	17
catalog	1002001	4	1	66896.68	15
catalog	1002001	4	NULL	182427.69	32
catalog	1002001	NULL	NULL	2114110.72	380
catalog	NULL	NULL	NULL	237410857.47	46322
