-- Automatically generated by TPCDSQueryTestSuite

-- !query
WITH ss AS
(SELECT
    s_store_sk,
    sum(ss_ext_sales_price) AS sales,
    sum(ss_net_profit) AS profit
  FROM store_sales, date_dim, store
  WHERE ss_sold_date_sk = d_date_sk
    AND d_date BETWEEN cast('2000-08-03' AS DATE) AND
  (cast('2000-08-03' AS DATE) + INTERVAL 30 days)
    AND ss_store_sk = s_store_sk
  GROUP BY s_store_sk),
    sr AS
  (SELECT
    s_store_sk,
    sum(sr_return_amt) AS returns,
    sum(sr_net_loss) AS profit_loss
  FROM store_returns, date_dim, store
  WHERE sr_returned_date_sk = d_date_sk
    AND d_date BETWEEN cast('2000-08-03' AS DATE) AND
  (cast('2000-08-03' AS DATE) + INTERVAL 30 days)
    AND sr_store_sk = s_store_sk
  GROUP BY s_store_sk),
    cs AS
  (SELECT
    cs_call_center_sk,
    sum(cs_ext_sales_price) AS sales,
    sum(cs_net_profit) AS profit
  FROM catalog_sales, date_dim
  WHERE cs_sold_date_sk = d_date_sk
    AND d_date BETWEEN cast('2000-08-03' AS DATE) AND
  (cast('2000-08-03' AS DATE) + INTERVAL 30 days)
  GROUP BY cs_call_center_sk),
    cr AS
  (SELECT
    sum(cr_return_amount) AS returns,
    sum(cr_net_loss) AS profit_loss
  FROM catalog_returns, date_dim
  WHERE cr_returned_date_sk = d_date_sk
    AND d_date BETWEEN cast('2000-08-03' AS DATE) AND
  (cast('2000-08-03' AS DATE) + INTERVAL 30 days)),
    ws AS
  (SELECT
    wp_web_page_sk,
    sum(ws_ext_sales_price) AS sales,
    sum(ws_net_profit) AS profit
  FROM web_sales, date_dim, web_page
  WHERE ws_sold_date_sk = d_date_sk
    AND d_date BETWEEN cast('2000-08-03' AS DATE) AND
  (cast('2000-08-03' AS DATE) + INTERVAL 30 days)
    AND ws_web_page_sk = wp_web_page_sk
  GROUP BY wp_web_page_sk),
    wr AS
  (SELECT
    wp_web_page_sk,
    sum(wr_return_amt) AS returns,
    sum(wr_net_loss) AS profit_loss
  FROM web_returns, date_dim, web_page
  WHERE wr_returned_date_sk = d_date_sk
    AND d_date BETWEEN cast('2000-08-03' AS DATE) AND
  (cast('2000-08-03' AS DATE) + INTERVAL 30 days)
    AND wr_web_page_sk = wp_web_page_sk
  GROUP BY wp_web_page_sk)
SELECT
  channel,
  id,
  sum(sales) AS sales,
  sum(returns) AS returns,
  sum(profit) AS profit
FROM
  (SELECT
     'store channel' AS channel,
     ss.s_store_sk AS id,
     sales,
     coalesce(returns, 0) AS returns,
     (profit - coalesce(profit_loss, 0)) AS profit
   FROM ss
     LEFT JOIN sr
       ON ss.s_store_sk = sr.s_store_sk
   UNION ALL
   SELECT
     'catalog channel' AS channel,
     cs_call_center_sk AS id,
     sales,
     returns,
     (profit - profit_loss) AS profit
   FROM cs, cr
   UNION ALL
   SELECT
     'web channel' AS channel,
     ws.wp_web_page_sk AS id,
     sales,
     coalesce(returns, 0) returns,
     (profit - coalesce(profit_loss, 0)) AS profit
   FROM ws
     LEFT JOIN wr
       ON ws.wp_web_page_sk = wr.wp_web_page_sk
  ) x
GROUP BY ROLLUP (channel, id)
ORDER BY channel, id
LIMIT 100
-- !query schema
struct<channel:string,id:int,sales:decimal(27,2),returns:decimal(27,2),profit:decimal(28,2)>
-- !query output
NULL	NULL	232221465.82	11982952.24	-68693883.13
catalog channel	1	25711965.54	2023352.51	-3771095.61
catalog channel	2	28086925.07	2023352.51	-4541761.49
catalog channel	5	26038313.82	2023352.51	-3728482.82
catalog channel	NULL	137152.08	2023352.51	-1206689.53
catalog channel	NULL	79974356.51	8093410.04	-13248029.45
store channel	1	20239898.89	466074.41	-8960721.41
store channel	10	18338714.31	407136.49	-8203710.83
store channel	2	18685269.96	499636.85	-8303557.71
store channel	4	18220984.73	476189.91	-8081714.38
store channel	7	18479892.97	441765.11	-8293817.25
store channel	8	19133082.76	421870.78	-8229334.94
store channel	NULL	113097843.62	2712673.55	-50072856.52
web channel	1	1134370.18	33708.02	-204736.67
web channel	11	1393565.07	3725.57	-128622.50
web channel	13	1305407.77	49095.15	-179156.86
web channel	14	1256685.71	56136.21	-102910.91
web channel	17	1160559.59	23583.28	-239765.01
web channel	19	1268894.72	53596.49	-143153.80
web channel	2	1278850.93	78555.79	-170621.58
web channel	20	1491727.00	40836.74	-77425.04
web channel	23	1271377.03	20426.59	-155810.24
web channel	25	1403075.58	59322.26	-128863.54
web channel	26	1378469.43	50643.40	-209820.30
web channel	29	1306617.24	11620.07	-106460.84
web channel	31	1259052.95	30070.06	-204204.53
web channel	32	1267535.92	40912.79	-241149.98
web channel	35	1444107.04	18453.02	-168768.73
web channel	37	1213368.27	35306.36	-105838.64
web channel	38	1181028.89	47051.91	-237237.65
web channel	41	1433769.99	21767.83	-171330.18
web channel	43	1204792.54	61542.23	-194684.36
web channel	44	1256347.03	39623.33	-217245.00
web channel	47	1224412.02	24343.16	-204725.18
web channel	49	1328985.68	40280.86	-203198.42
web channel	5	1319939.65	26784.53	-149622.50
web channel	50	1292794.11	77184.10	-222419.55
web channel	53	1324237.98	3313.53	-176658.22
web channel	55	1361712.89	42507.36	-177506.52
web channel	56	1343468.89	79233.52	-215418.50
web channel	59	1389900.87	11703.28	-143343.89
web channel	7	1389519.73	62874.96	-216688.03
web channel	8	1264690.99	32666.25	-275609.99
web channel	NULL	39149265.69	1176868.65	-5372997.16
