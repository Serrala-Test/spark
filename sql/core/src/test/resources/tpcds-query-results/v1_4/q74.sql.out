-- Automatically generated by TPCDSQueryTestSuite

-- !query
WITH year_total AS (
  SELECT
    c_customer_id customer_id,
    c_first_name customer_first_name,
    c_last_name customer_last_name,
    d_year AS year,
    sum(ss_net_paid) year_total,
    's' sale_type
  FROM
    customer, store_sales, date_dim
  WHERE c_customer_sk = ss_customer_sk
    AND ss_sold_date_sk = d_date_sk
    AND d_year IN (2001, 2001 + 1)
  GROUP BY
    c_customer_id, c_first_name, c_last_name, d_year
  UNION ALL
  SELECT
    c_customer_id customer_id,
    c_first_name customer_first_name,
    c_last_name customer_last_name,
    d_year AS year,
    sum(ws_net_paid) year_total,
    'w' sale_type
  FROM
    customer, web_sales, date_dim
  WHERE c_customer_sk = ws_bill_customer_sk
    AND ws_sold_date_sk = d_date_sk
    AND d_year IN (2001, 2001 + 1)
  GROUP BY
    c_customer_id, c_first_name, c_last_name, d_year)
SELECT
  t_s_secyear.customer_id,
  t_s_secyear.customer_first_name,
  t_s_secyear.customer_last_name
FROM
  year_total t_s_firstyear, year_total t_s_secyear,
  year_total t_w_firstyear, year_total t_w_secyear
WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_secyear.customer_id
  AND t_s_firstyear.customer_id = t_w_firstyear.customer_id
  AND t_s_firstyear.sale_type = 's'
  AND t_w_firstyear.sale_type = 'w'
  AND t_s_secyear.sale_type = 's'
  AND t_w_secyear.sale_type = 'w'
  AND t_s_firstyear.year = 2001
  AND t_s_secyear.year = 2001 + 1
  AND t_w_firstyear.year = 2001
  AND t_w_secyear.year = 2001 + 1
  AND t_s_firstyear.year_total > 0
  AND t_w_firstyear.year_total > 0
  AND CASE WHEN t_w_firstyear.year_total > 0
  THEN t_w_secyear.year_total / t_w_firstyear.year_total
      ELSE NULL END
  > CASE WHEN t_s_firstyear.year_total > 0
  THEN t_s_secyear.year_total / t_s_firstyear.year_total
    ELSE NULL END
ORDER BY 1, 1, 1
LIMIT 100
-- !query schema
struct<customer_id:string,customer_first_name:string,customer_last_name:string>
-- !query output
AAAAAAAAAMGDAAAA	Kenneth	Harlan
AAAAAAAAANFAAAAA	Philip	Banks
AAAAAAAAAOPFBAAA	Jerry	Fields
AAAAAAAABLEIBAAA	Paula	Wakefield
AAAAAAAABNBBAAAA	Irma	Smith
AAAAAAAACADPAAAA	Cristobal	Thomas
AAAAAAAACFCGBAAA	Marcus	Sanders
AAAAAAAACFENAAAA	Christopher	Dawson
AAAAAAAACIJMAAAA	Elizabeth	Thomas
AAAAAAAACJDIAAAA	James	Kerr
AAAAAAAACNAGBAAA	Virginia	May
AAAAAAAADBEFBAAA	Bennie	Bowers
AAAAAAAADCKOAAAA	Robert	Gonzalez
AAAAAAAADFIEBAAA	John	Gray
AAAAAAAADFKABAAA	Latoya	Craft
AAAAAAAADIIOAAAA	David	Carroll
AAAAAAAADIJGBAAA	Ruth	Sanders
AAAAAAAADLHBBAAA	Henry	Bertrand
AAAAAAAAEADJAAAA	Ruth	Carroll
AAAAAAAAEJDLAAAA	Alice	Wright
AAAAAAAAEKFPAAAA	Annika	Chin
AAAAAAAAEKJLAAAA	Aisha	Carlson
AAAAAAAAEOAKAAAA	Molly	Benjamin
AAAAAAAAEPOGAAAA	Felisha	Mendes
AAAAAAAAFACEAAAA	Priscilla	Miller
AAAAAAAAFBAHAAAA	Michael	Williams
AAAAAAAAFGIGAAAA	Eduardo	Miller
AAAAAAAAFGPGAAAA	Albert	Wadsworth
AAAAAAAAFHACBAAA	NULL	NULL
AAAAAAAAFJHFAAAA	Larissa	Roy
AAAAAAAAFMHIAAAA	Emilio	Darling
AAAAAAAAFOGIAAAA	Michelle	Greene
AAAAAAAAFOJAAAAA	Don	Castillo
AAAAAAAAGEHIAAAA	Tyler	Miller
AAAAAAAAGFMDBAAA	Kathleen	Gibson
AAAAAAAAGHPBBAAA	Nick	Mendez
AAAAAAAAGNDAAAAA	Terry	Mcdowell
AAAAAAAAHGOABAAA	Sonia	White
AAAAAAAAHHCABAAA	William	Stewart
AAAAAAAAHJLAAAAA	Audrey	Beltran
AAAAAAAAHMJNAAAA	Ryan	Baptiste
AAAAAAAAHMOIAAAA	Grace	Henderson
AAAAAAAAHNFHAAAA	Rebecca	Wilson
AAAAAAAAIADEBAAA	Diane	Aldridge
AAAAAAAAIBAEBAAA	Sandra	Wilson
AAAAAAAAIBFCBAAA	Ruth	Grantham
AAAAAAAAIBHHAAAA	Jennifer	Ballard
AAAAAAAAICHFAAAA	Linda	Mccoy
AAAAAAAAIDKFAAAA	Michael	Mack
AAAAAAAAIJEMAAAA	Charlie	Cummings
AAAAAAAAIMHBAAAA	Kathy	Knowles
AAAAAAAAIMHHBAAA	Lillian	Davidson
AAAAAAAAJEKFBAAA	Norma	Burkholder
AAAAAAAAJGMMAAAA	Richard	Larson
AAAAAAAAJIALAAAA	Santos	Gutierrez
AAAAAAAAJKBNAAAA	Julie	Kern
AAAAAAAAJONHBAAA	Warren	Orozco
AAAAAAAAKAECAAAA	Milton	Mackey
AAAAAAAAKBCABAAA	Debra	Bell
AAAAAAAAKJBKAAAA	Georgia	Scott
AAAAAAAAKJBLAAAA	Kerry	Davis
AAAAAAAAKKGEAAAA	Katie	Dunbar
AAAAAAAAKLHHBAAA	Manuel	Castaneda
AAAAAAAAKNAKAAAA	Gladys	Banks
AAAAAAAAKOJJAAAA	Gracie	Mendoza
AAAAAAAALFKKAAAA	Ignacio	Miller
AAAAAAAALHMCAAAA	Brooke	Nelson
AAAAAAAALIOPAAAA	Derek	Allen
AAAAAAAALJNCBAAA	George	Gamez
AAAAAAAAMDCAAAAA	Louann	Hamel
AAAAAAAAMFFLAAAA	Margret	Gray
AAAAAAAAMMOBBAAA	Margaret	Smith
AAAAAAAANFBDBAAA	Vernice	Fernandez
AAAAAAAANGDBBAAA	Carlos	Jewell
AAAAAAAANIPLAAAA	Eric	Lawrence
AAAAAAAANJAGAAAA	Allen	Hood
AAAAAAAANJHCBAAA	Christopher	Schreiber
AAAAAAAAOBADBAAA	Elizabeth	Burnham
AAAAAAAAOCAJAAAA	Jenna	Staton
AAAAAAAAOCDJAAAA	Nina	Sanchez
AAAAAAAAOCICAAAA	Zachary	Pennington
AAAAAAAAOCLBBAAA	NULL	NULL
AAAAAAAAOFLCAAAA	James	Taylor
AAAAAAAAOPDLAAAA	Ann	Pence
AAAAAAAAPDFBAAAA	Terrance	Banks
AAAAAAAAPEHEBAAA	Edith	Molina
AAAAAAAAPFCLAAAA	Felicia	Neville
AAAAAAAAPJENAAAA	Ashley	Norton
AAAAAAAAPKBCBAAA	Andrea	White
AAAAAAAAPKIKAAAA	Wendy	Horvath
AAAAAAAAPMMBBAAA	Paul	Jordan
AAAAAAAAPPIBBAAA	Candice	Lee
